<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0F0F14">
    <title>ESMEPro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           VARIABLES & RESET
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --primary-dark: #4F46E5;
            --accent: #F59E0B;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-purple: #A855F7;
            --accent-cyan: #06B6D4;
            --bg: #0F0F14;
            --bg-elevated: #18181F;
            --bg-card: #1C1C24;
            --bg-card-hover: #24242E;
            --border: rgba(255,255,255,0.08);
            --border-focus: rgba(99,102,241,0.3);
            --text: #F9FAFB;
            --text-secondary: #9CA3AF;
            --text-tertiary: #6B7280;
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
            --glow: 0 0 30px rgba(99,102,241,0.2);
            --nav-height: 72px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
        }
        [data-theme="light"] {
            --bg: #F0F2F8; --bg-elevated: #FFFFFF; --bg-card: #FFFFFF;
            --bg-card-hover: #F3F4F6; --border: rgba(0,0,0,0.07);
            --border-focus: rgba(99,102,241,0.3); --text: #111827;
            --text-secondary: #6B7280; --text-tertiary: #9CA3AF;
            --shadow: 0 4px 20px rgba(0,0,0,0.08); --glow: 0 0 20px rgba(99,102,241,0.12);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESKTOP LAYOUT (sidebar nav)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .desktop-nav {
            width: 260px;
            background: var(--bg-elevated);
            border-right: 1px solid var(--border);
            padding: 28px 20px;
            position: fixed;
            top: 0; left: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }
        .nav-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; padding: 0 8px; }
        .nav-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: var(--glow); animation: float 3s ease-in-out infinite; flex-shrink: 0; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
        .nav-logo-text { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 800; }
        .nav-logo-text span { background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .nav-section-label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-tertiary); margin: 20px 0 10px; padding: 0 12px; }
        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 13px 14px; margin-bottom: 4px; background: transparent; border: 1px solid transparent; border-radius: 12px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; text-align: left; position: relative; overflow: hidden; }
        .nav-btn::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--primary); transform:scaleY(0); transition:transform 0.2s; border-radius:0 2px 2px 0; }
        .nav-btn:hover { background: var(--bg-card); color: var(--text); transform: translateX(2px); }
        .nav-btn.active { background: var(--bg-card); color: var(--primary); border-color: var(--border-focus); }
        .nav-btn.active::before { transform: scaleY(1); }
        .nav-icon { font-size: 1.1rem; width: 22px; text-align: center; flex-shrink: 0; }
        .desktop-theme-toggle { margin-top: auto; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; }
        .desktop-theme-toggle:hover { border-color: var(--border-focus); }
        .toggle-label { display: flex; align-items: center; gap: 10px; font-size: 0.88rem; font-weight: 500; }
        .toggle-switch { width: 40px; height: 22px; background: var(--bg); border-radius: 100px; position: relative; transition: all 0.3s; flex-shrink: 0; }
        .toggle-switch::after { content:''; position:absolute; top:3px; left:3px; width:16px; height:16px; background:var(--text-tertiary); border-radius:50%; transition:all 0.3s; }
        [data-theme="light"] .toggle-switch { background: var(--primary); }
        [data-theme="light"] .toggle-switch::after { left:21px; background:white; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE TOP BAR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .mobile-topbar {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0;
            height: calc(56px + var(--safe-top));
            padding-top: var(--safe-top);
            background: rgba(15,15,20,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 200;
            align-items: center;
            justify-content: space-between;
            padding-left: 20px;
            padding-right: 20px;
        }
        [data-theme="light"] .mobile-topbar { background: rgba(240,242,248,0.9); }
        .mobile-topbar-logo { display: flex; align-items: center; gap: 10px; }
        .mobile-topbar-logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .mobile-topbar-logo-text { font-family: 'Playfair Display', serif; font-size: 1.05rem; font-weight: 800; }
        .mobile-topbar-logo-text span { background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .mobile-topbar-actions { display: flex; align-items: center; gap: 8px; }
        .topbar-btn { width: 36px; height: 36px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .topbar-btn:active { transform: scale(0.93); background: var(--bg-card-hover); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE BOTTOM NAV
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: rgba(15,15,20,0.92);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-top: 1px solid var(--border);
            z-index: 200;
            align-items: flex-start;
            justify-content: space-around;
            padding-top: 10px;
        }
        [data-theme="light"] .mobile-bottom-nav { background: rgba(255,255,255,0.92); }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 6px 16px; border-radius: 14px; cursor: pointer; transition: all 0.2s; border: none; background: transparent; color: var(--text-tertiary); min-width: 60px; }
        .mobile-nav-item:active { transform: scale(0.91); }
        .mobile-nav-item.active { color: var(--primary); }
        .mobile-nav-icon { font-size: 1.3rem; position: relative; transition: transform 0.2s; }
        .mobile-nav-item.active .mobile-nav-icon { transform: translateY(-2px); }
        .mobile-nav-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--primary); opacity: 0; transition: opacity 0.2s; margin-top: -2px; }
        .mobile-nav-item.active .mobile-nav-dot { opacity: 1; }
        .mobile-nav-label { font-size: 0.65rem; font-weight: 600; letter-spacing: 0.02em; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN CONTENT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        main {
            margin-left: 260px;
            padding: 36px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }
        main::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(99,102,241,0.04) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(245,158,11,0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .section { display: none; animation: fadeIn 0.35s ease; position: relative; z-index: 1; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PAGE HEADER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .page-header { margin-bottom: 28px; }
        .page-meta { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .page-meta::before { content:''; width:20px; height:2px; background:var(--primary); }
        .page-title { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 800; line-height: 1.1; margin-bottom: 8px; background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-description { font-size: 0.95rem; color: var(--text-secondary); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARDS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 18px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow); transition: border-color 0.3s, transform 0.2s; }
        .card:hover { border-color: var(--border-focus); }
        .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .card-title::before { content:''; width:4px; height:18px; background:linear-gradient(180deg, var(--primary), var(--primary-light)); border-radius:2px; flex-shrink:0; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           STATS GRID
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 16px; position: relative; overflow: hidden; transition: all 0.25s; }
        .stat-card::before { content:''; position:absolute; top:0; right:0; width:80px; height:80px; background:var(--primary); opacity:0.05; border-radius:50%; transform:translate(30%,-30%); }
        .stat-card:hover { border-color: var(--border-focus); transform: translateY(-3px); box-shadow: var(--glow); }
        .stat-label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-tertiary); margin-bottom: 8px; }
        .stat-value { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 4px; }
        .stat-sub { font-size: 0.75rem; color: var(--text-secondary); }
        .stat-bar { margin-top: 12px; height: 4px; background: var(--bg); border-radius: 100px; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); border-radius: 100px; transition: width 1s cubic-bezier(0.4,0,0.2,1); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           UE OVERVIEW (dashboard)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .ue-overview { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .ue-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; transition: all 0.25s; position: relative; overflow: hidden; }
        .ue-card::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; background:linear-gradient(90deg, var(--primary), var(--accent)); transform:scaleX(0); transition:transform 0.3s; }
        .ue-card:hover { border-color: var(--border-focus); transform: translateY(-2px); }
        .ue-card:hover::after { transform: scaleX(1); }
        .ue-code { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--primary); margin-bottom: 4px; font-weight: 600; }
        .ue-name { font-size: 0.78rem; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.3; }
        .ue-average { font-size: 1.8rem; font-weight: 800; font-family: 'JetBrains Mono', monospace; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TODAY SCHEDULE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .today-schedule { display: flex; flex-direction: column; gap: 10px; }
        .course-item { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 14px; display: flex; align-items: flex-start; gap: 12px; transition: all 0.2s; }
        .course-item:hover { border-color: var(--border-focus); }
        .course-item.current { border-color: var(--accent-green); box-shadow: 0 0 0 3px rgba(16,185,129,0.1); }
        .course-item.next { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .course-time-block { display: flex; flex-direction: column; align-items: center; min-width: 58px; }
        .course-start { font-family: 'JetBrains Mono', monospace; font-size: 0.88rem; font-weight: 700; color: var(--primary); }
        .course-end { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-tertiary); }
        .course-details { flex: 1; min-width: 0; }
        .course-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap; }
        .course-title-text { font-weight: 600; font-size: 0.9rem; }
        .time-badge { padding: 3px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .time-badge.current { background: var(--accent-green); color: white; }
        .time-badge.soon { background: var(--accent-red); color: white; }
        .time-badge.upcoming { background: var(--accent); color: white; }
        .time-badge.later { background: var(--bg-card); color: var(--text-tertiary); border: 1px solid var(--border); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FORMS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-grid { display: grid; gap: 10px; }
        input, select, textarea {
            font-family: 'Outfit', sans-serif; font-size: 0.9rem;
            padding: 12px 14px; background: var(--bg);
            border: 1px solid var(--border); border-radius: 10px;
            color: var(--text); transition: all 0.2s;
            width: 100%;
            -webkit-appearance: none;
        }
        input::placeholder, textarea::placeholder { color: var(--text-tertiary); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.12); }
        .input-grow { flex: 1; min-width: 140px; }
        select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%236B7280' d='M6 8L0 0h12z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BUTTONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn { font-family: 'Outfit', sans-serif; font-size: 0.88rem; font-weight: 600; padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 7px; white-space: nowrap; min-height: 44px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
        .btn-primary:hover { box-shadow: 0 6px 18px rgba(99,102,241,0.4); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--border-focus); }
        .btn-danger { background: transparent; color: var(--accent-red); border: 1px solid rgba(239,68,68,0.3); padding: 8px 14px; font-size: 0.78rem; min-height: 36px; }
        .btn-danger:hover { background: rgba(239,68,68,0.1); }
        .btn-full { width: 100%; }
        .btn-today { background: rgba(99,102,241,0.12); color: var(--primary); border: 1px solid var(--border-focus); padding: 6px 16px; border-radius: 18px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; animation: pulseToday 2s ease-in-out infinite; min-height: 34px; margin-top: 8px; }
        .btn-today:hover { background: var(--primary); color: white; animation: none; }
        @keyframes pulseToday { 0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,0.35)} 50%{box-shadow:0 0 0 6px rgba(99,102,241,0)} }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GRADES â€” UE TABS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .ue-tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .ue-tab { background: var(--bg-card); border: 1px solid var(--border); border-radius: 13px; padding: 14px 12px; cursor: pointer; transition: all 0.2s; text-align: left; }
        .ue-tab:hover { border-color: var(--border-focus); transform: translateY(-2px); }
        .ue-tab.active { background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(99,102,241,0.05)); border-color: var(--primary); }
        .ue-tab-code { font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--primary); margin-bottom: 5px; font-weight: 600; }
        .ue-tab-name { font-size: 0.82rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
        .ue-tab-ects { font-size: 0.7rem; color: var(--text-tertiary); }
        .ue-panel { display: none; } .ue-panel.active { display: block; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODULE CARDS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .module-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; transition: all 0.25s; }
        .module-card:hover { border-color: var(--border-focus); transform: translateY(-2px); }
        .module-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; gap: 8px; }
        .module-name { font-size: 0.9rem; font-weight: 600; flex: 1; line-height: 1.4; }
        .module-meta { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .module-sem { font-family: 'JetBrains Mono', monospace; font-size: 0.62rem; color: var(--text-tertiary); background: var(--bg); padding: 3px 7px; border-radius: 5px; }
        .module-coef { font-family: 'JetBrains Mono', monospace; font-size: 0.62rem; color: var(--accent); background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.2); padding: 3px 7px; border-radius: 5px; }
        .eval-weights { margin-bottom: 12px; }
        .eval-weights-title { font-size: 0.65rem; color: var(--text-tertiary); margin-bottom: 5px; font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 0.04em; }
        .eval-weight-bar { display: flex; height: 20px; border-radius: 7px; overflow: hidden; gap: 2px; }
        .eval-weight-seg { display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: white; border-radius: 3px; overflow: hidden; white-space: nowrap; min-width: 0; padding: 0 3px; cursor: default; }
        .module-grades { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 14px; min-height: 28px; }
        .grade-chip { display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 7px; font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; }
        .grade-chip.high { border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.05); color: var(--accent-green); }
        .grade-chip.mid { border-color: rgba(245,158,11,0.3); background: rgba(245,158,11,0.05); color: var(--accent); }
        .grade-chip.low { border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.05); color: var(--accent-red); }
        .grade-type { color: var(--text-tertiary); font-size: 0.65rem; }
        .grade-del { cursor: pointer; opacity: 0.5; transition: opacity 0.2s; padding: 2px; }
        .grade-del:hover { opacity: 1; color: var(--accent-red); }
        .module-average { display: flex; align-items: center; gap: 10px; }
        .avg-label { font-size: 0.7rem; color: var(--text-tertiary); min-width: 50px; }
        .avg-bar { flex: 1; height: 4px; background: var(--bg); border-radius: 100px; overflow: hidden; }
        .avg-bar-fill { height: 100%; border-radius: 100px; transition: width 0.6s cubic-bezier(0.4,0,0.2,1); }
        .avg-value { font-family: 'JetBrains Mono', monospace; font-size: 0.88rem; font-weight: 600; min-width: 38px; text-align: right; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TASKS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .task-item { display: flex; align-items: center; gap: 12px; padding: 13px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 11px; margin-bottom: 8px; transition: all 0.2s; }
        .task-item:hover { border-color: var(--border-focus); }
        .task-item.done { opacity: 0.5; }
        .task-check { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; font-size: 0.75rem; color: white; min-width: 22px; }
        .task-check:hover { border-color: var(--primary); }
        .task-item.done .task-check { background: var(--primary); border-color: var(--primary); }
        .task-text { flex: 1; cursor: pointer; font-size: 0.9rem; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .task-item.done .task-text { text-decoration: line-through; color: var(--text-tertiary); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SCHEDULE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .week-nav { display: flex; align-items: center; justify-content: space-between; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; gap: 12px; }
        .week-info { text-align: center; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .week-number { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--primary); margin-bottom: 4px; }
        .week-dates { font-size: 1.05rem; font-weight: 700; }
        .schedule-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .day-column { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; min-height: 160px; }
        .day-header { background: var(--bg); padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
        .day-name { font-size: 0.68rem; font-weight: 700; color: var(--primary); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.05em; }
        .day-date { font-size: 0.85rem; font-weight: 700; }
        .day-body { padding: 10px; }
        .course-slot { background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.2); border-radius: 9px; padding: 10px; margin-bottom: 7px; position: relative; cursor: pointer; transition: all 0.2s; }
        .course-slot:hover { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.3); }
        .course-slot:hover::after { content:'ğŸ—‘ï¸'; position:absolute; top:4px; right:6px; font-size:0.7rem; }
        .course-time { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--primary); margin-bottom: 4px; }
        .course-name { font-weight: 600; font-size: 0.78rem; margin-bottom: 3px; line-height: 1.3; }
        .course-loc { font-size: 0.68rem; color: var(--text-tertiary); }

        /* ICS */
        .ics-panel { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-top: 14px; }
        .ics-progress { margin-top: 10px; display: none; }
        .ics-progress-bar { height: 3px; background: var(--bg-card); border-radius: 100px; overflow: hidden; margin-bottom: 6px; }
        .ics-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); animation: icsLoading 1.5s ease-in-out infinite; }
        @keyframes icsLoading { 0%{width:5%} 50%{width:80%} 100%{width:95%} }
        .ics-status-msg { font-size: 0.8rem; color: var(--text-tertiary); font-family: 'JetBrains Mono', monospace; }
        .ics-status-ok { color: var(--accent-green) !important; }
        .ics-status-err { color: var(--accent-red) !important; }
        .ics-status-warn { color: var(--accent) !important; }
        .proxy-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
        .proxy-chip { padding: 3px 9px; border-radius: 6px; font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; border: 1px solid var(--border); color: var(--text-tertiary); transition: all 0.2s; }
        .proxy-chip.trying { border-color: var(--accent); color: var(--accent); background: rgba(245,158,11,0.05); }
        .proxy-chip.ok { border-color: var(--accent-green); color: var(--accent-green); background: rgba(16,185,129,0.05); }
        .proxy-chip.fail { border-color: var(--accent-red); color: var(--accent-red); background: rgba(239,68,68,0.05); text-decoration: line-through; opacity: 0.5; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESOURCES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .res-toolbar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
        .res-search-wrap { display: flex; align-items: center; gap: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 11px; padding: 10px 14px; flex: 1; min-width: 180px; transition: all 0.2s; }
        .res-search-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
        .res-search-icon { font-size: 0.95rem; color: var(--text-tertiary); }
        .res-search-wrap input { flex: 1; background: transparent; border: none; padding: 0; font-size: 0.88rem; color: var(--text); }
        .res-search-wrap input:focus { outline: none; box-shadow: none; }
        .res-ue-tabs { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 20px; }
        .res-ue-tab { display: flex; align-items: center; gap: 7px; padding: 9px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 11px; font-size: 0.82rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; min-height: 40px; }
        .res-ue-tab:hover { border-color: var(--border-focus); color: var(--text); }
        .res-ue-tab.active { border-color: var(--primary); color: var(--text); box-shadow: 0 0 0 2px rgba(99,102,241,0.1); }
        .res-ue-tab-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .res-ue-tab-count { background: var(--bg); border: 1px solid var(--border); border-radius: 18px; padding: 1px 7px; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-tertiary); }
        .res-ue-tab.active .res-ue-tab-count { background: var(--primary); border-color: var(--primary); color: white; }
        .resource-filters { display: flex; gap: 7px; flex-wrap: wrap; margin-bottom: 16px; }
        .filter-btn { padding: 7px 14px; border-radius: 9px; border: 1px solid var(--border); background: var(--bg); color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; min-height: 38px; }
        .filter-btn:hover { border-color: var(--primary); color: var(--primary); }
        .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .res-ue-block { margin-bottom: 24px; }
        .res-ue-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 14px 18px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; cursor: pointer; transition: all 0.2s; user-select: none; }
        .res-ue-header:hover { border-color: var(--border-focus); }
        .res-ue-stripe { width: 4px; height: 32px; border-radius: 3px; flex-shrink: 0; }
        .res-ue-header-info { flex: 1; }
        .res-ue-header-code { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; margin-bottom: 3px; }
        .res-ue-header-name { font-size: 0.92rem; font-weight: 700; }
        .res-ue-header-stats { display: flex; gap: 7px; align-items: center; }
        .res-ue-badge { padding: 3px 10px; border-radius: 7px; font-family: 'JetBrains Mono', monospace; font-size: 0.67rem; font-weight: 600; border: 1px solid var(--border); background: var(--bg); color: var(--text-secondary); }
        .res-ue-chevron { font-size: 0.75rem; color: var(--text-tertiary); transition: transform 0.25s; }
        .res-ue-block.collapsed .res-ue-chevron { transform: rotate(-90deg); }
        .res-ue-block.collapsed .res-ue-body { display: none; }
        .res-module-block { margin-bottom: 10px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: border-color 0.2s; }
        .res-module-block:hover { border-color: var(--border-focus); }
        .res-module-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); cursor: pointer; transition: background 0.2s; user-select: none; }
        .res-module-header:hover { background: var(--bg-card-hover); }
        .res-module-icon { width: 30px; height: 30px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; flex-shrink: 0; color: white; }
        .res-module-name { flex: 1; font-size: 0.85rem; font-weight: 600; }
        .res-module-sem { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-tertiary); background: var(--bg); border: 1px solid var(--border); padding: 2px 7px; border-radius: 5px; }
        .res-module-count { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-tertiary); }
        .res-module-chevron { font-size: 0.7rem; color: var(--text-tertiary); transition: transform 0.2s; }
        .res-module-block.collapsed .res-module-chevron { transform: rotate(-90deg); }
        .res-module-block.collapsed .res-module-body { display: none; }
        .res-module-body { background: var(--bg); padding: 10px 14px; display: flex; flex-direction: column; gap: 7px; }
        .res-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 9px; transition: all 0.2s; }
        .res-row:hover { border-color: var(--border-focus); transform: translateX(3px); }
        .res-cat-pill { display: flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; flex-shrink: 0; white-space: nowrap; }
        .res-row-title { flex: 1; font-size: 0.83rem; font-weight: 500; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .res-row-open { display: flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 7px; background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.2); color: var(--primary); font-size: 0.75rem; font-weight: 600; text-decoration: none; transition: all 0.2s; flex-shrink: 0; min-height: 34px; cursor: pointer; }
        .res-row-open:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .res-row-pdf { display: flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 7px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); color: var(--accent-red); font-size: 0.75rem; font-weight: 600; text-decoration: none; transition: all 0.2s; flex-shrink: 0; min-height: 34px; cursor: pointer; }
        .res-row-pdf:hover { background: var(--accent-red); color: white; border-color: var(--accent-red); }
        .res-empty-ue { padding: 50px 20px; text-align: center; color: var(--text-tertiary); }
        .res-empty-ue-icon { font-size: 2.2rem; margin-bottom: 10px; opacity: 0.4; }
        .res-empty-ue-text { font-size: 0.95rem; font-weight: 600; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PDF UPLOAD AREA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .res-input-tabs { display: flex; gap: 6px; margin-bottom: 10px; }
        .res-input-tab { padding: 7px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text-secondary); font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .res-input-tab.active { background: rgba(99,102,241,0.12); border-color: var(--primary); color: var(--primary); }
        .res-input-panel { display: none; }
        .res-input-panel.active { display: block; }
        .pdf-drop-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all 0.25s; background: var(--bg); position: relative; }
        .pdf-drop-zone:hover, .pdf-drop-zone.dragover { border-color: var(--primary); background: rgba(99,102,241,0.05); }
        .pdf-drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .pdf-drop-icon { font-size: 2rem; margin-bottom: 8px; }
        .pdf-drop-text { font-size: 0.88rem; color: var(--text-secondary); font-weight: 500; }
        .pdf-drop-sub { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 4px; }
        .pdf-selected { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.3); border-radius: 10px; margin-top: 10px; font-size: 0.85rem; }
        .pdf-selected-name { flex: 1; font-weight: 600; color: var(--accent-green); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pdf-selected-size { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-tertiary); flex-shrink: 0; }
        .pdf-clear { cursor: pointer; color: var(--accent-red); font-size: 0.85rem; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s; }
        .pdf-clear:hover { opacity: 1; }
        .pdf-size-warn { font-size: 0.75rem; color: var(--accent); font-family: 'JetBrains Mono', monospace; margin-top: 6px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PDF VIEWER MODAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #pdfModal { position: fixed; inset: 0; z-index: 9999; display: none; flex-direction: column; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); animation: modalIn 0.25s ease; }
        @keyframes modalIn { from{opacity:0} to{opacity:1} }
        #pdfModal.open { display: flex; }
        .pdf-modal-header { display: flex; align-items: center; gap: 14px; padding: 14px 20px; background: var(--bg-elevated); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .pdf-modal-title { flex: 1; font-size: 0.92rem; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pdf-modal-actions { display: flex; gap: 8px; }
        .pdf-modal-btn { display: flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; white-space: nowrap; }
        .pdf-modal-btn:hover { border-color: var(--border-focus); background: var(--bg-card-hover); }
        .pdf-modal-close { width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .pdf-modal-close:hover { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.4); color: var(--accent-red); }
        .pdf-modal-body { flex: 1; overflow: hidden; position: relative; }
        .pdf-modal-body iframe { width: 100%; height: 100%; border: none; }
        .pdf-modal-loading { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: var(--text-secondary); }
        .pdf-spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--bg-card); border: 1px solid var(--border-focus); border-radius: 12px; padding: 12px 24px; box-shadow: var(--glow); z-index: 1000; opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1); white-space: nowrap; font-size: 0.88rem; font-weight: 600; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TABLET BREAKPOINT (768pxâ€“1024px)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 1024px) {
            .desktop-nav { width: 220px; padding: 24px 16px; }
            main { margin-left: 220px; padding: 28px 24px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 12px; }
            .ue-overview { grid-template-columns: repeat(2, 1fr); }
            .ue-tabs { grid-template-columns: repeat(2, 1fr); }
            .modules-grid { grid-template-columns: 1fr; }
            .schedule-grid { grid-template-columns: repeat(3, 1fr); }
            .page-title { font-size: 2rem; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE BREAKPOINT (max 768px)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .mobile-topbar { display: flex; }
            .mobile-bottom-nav { display: flex; }
            #toast { bottom: calc(var(--nav-height) + var(--safe-bottom) + 12px); }

            main {
                margin-left: 0;
                padding: 16px;
                padding-top: calc(56px + var(--safe-top) + 16px);
                padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 16px);
            }

            .page-title { font-size: 1.8rem; }
            .page-description { font-size: 0.85rem; }
            .page-header { margin-bottom: 20px; }

            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            .stat-value { font-size: 2rem; }

            .ue-overview { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .ue-average { font-size: 1.5rem; }

            .ue-tabs { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .ue-tab { padding: 12px 10px; border-radius: 11px; }
            .ue-tab-name { font-size: 0.78rem; }

            .card { border-radius: 14px; padding: 18px; margin-bottom: 14px; }
            .card-title { font-size: 0.92rem; margin-bottom: 16px; }

            .modules-grid { grid-template-columns: 1fr; gap: 12px; }
            .module-card { border-radius: 12px; padding: 16px; }

            .form-row { flex-direction: column; gap: 8px; }
            .form-row .btn { width: 100%; }
            .form-row input, .form-row select { width: 100%; }
            .input-grow { min-width: unset; }

            .schedule-grid-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -16px; padding: 0 16px 8px; }
            .schedule-grid { grid-template-columns: repeat(5, 160px); gap: 10px; min-width: max-content; }
            .day-column { border-radius: 12px; min-height: 140px; }

            .week-nav { padding: 14px 16px; border-radius: 14px; }
            .week-nav .btn { padding: 10px 14px; font-size: 0.8rem; }
            .week-dates { font-size: 0.92rem; }

            .res-ue-tabs { gap: 6px; }
            .res-ue-tab { padding: 8px 12px; font-size: 0.78rem; }
            .filter-btn { padding: 6px 12px; font-size: 0.75rem; min-height: 36px; }
            .res-module-body { padding: 8px 10px; }
            .res-row { padding: 9px 10px; }

            .grade-form-row1 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
            .grade-form-row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }

            .course-item { padding: 12px; }
            .course-time-block { min-width: 50px; }

            .task-text { font-size: 0.85rem; }

            .ics-form-row { display: flex; flex-direction: column; gap: 8px; }
            .ics-form-row .btn { width: 100%; }

            /* PDF modal full screen on mobile */
            .pdf-modal-header { padding: 10px 14px; }
            .pdf-modal-actions { display: none; }
        }

        @media (max-width: 390px) {
            .stats-grid { gap: 8px; }
            .stat-card { padding: 16px 12px; }
            .stat-value { font-size: 1.8rem; }
            .ue-overview { gap: 8px; }
            .ue-average { font-size: 1.3rem; }
            main { padding: 12px; padding-top: calc(56px + var(--safe-top) + 12px); padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 12px); }
            .mobile-nav-item { min-width: 52px; padding: 6px 10px; }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .ue-overview { grid-template-columns: repeat(4, 1fr); }
        }

        .section.active { animation: mobileSlide 0.32s cubic-bezier(0.22,1,0.36,1); }
        @keyframes mobileSlide { from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:translateX(0)} }

        .scroll-x { overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .scroll-x::-webkit-scrollbar { display: none; }

        @media (hover: none) {
            .card:hover { transform: none; }
            .ue-tab:hover { transform: none; }
            .module-card:hover { transform: none; }
            .res-row:hover { transform: none; }
            .stat-card:hover { transform: none; }
        }
    </style>
</head>
<body>

    <!-- â•â•â• MOBILE TOP BAR â•â•â• -->
    <header class="mobile-topbar" id="mobileTopbar">
        <div class="mobile-topbar-logo">
            <div class="mobile-topbar-logo-icon">ğŸ“</div>
            <div class="mobile-topbar-logo-text">ESME<span>Pro</span></div>
        </div>
        <div class="mobile-topbar-actions">
            <div class="topbar-btn" onclick="toggleTheme()" title="ThÃ¨me">
                <span id="topbar-theme-icon">ğŸŒ™</span>
            </div>
        </div>
    </header>

    <!-- â•â•â• DESKTOP SIDEBAR NAV â•â•â• -->
    <nav class="desktop-nav">
        <div class="nav-logo">
            <div class="nav-logo-icon">ğŸ“</div>
            <div class="nav-logo-text">ESME<span>Pro</span></div>
        </div>
        <div class="nav-section-label">Navigation</div>
        <button class="nav-btn active" onclick="showSection('dashboard', this)"><span class="nav-icon">â—†</span>Tableau de bord</button>
        <button class="nav-btn" onclick="showSection('grades', this)"><span class="nav-icon">â—ˆ</span>Notes & Moyennes</button>
        <button class="nav-btn" onclick="showSection('schedule', this)"><span class="nav-icon">â—§</span>Emploi du temps</button>
        <button class="nav-btn" onclick="showSection('resources', this)"><span class="nav-icon">â—ª</span>Ressources</button>
        <div class="desktop-theme-toggle" onclick="toggleTheme()">
            <div class="toggle-label"><span id="theme-icon">ğŸŒ™</span><span id="theme-text">Mode Sombre</span></div>
            <div class="toggle-switch"></div>
        </div>
    </nav>

    <!-- â•â•â• MAIN CONTENT â•â•â• -->
    <main>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="page-header">
                <div class="page-meta">Vue d'ensemble</div>
                <h1 class="page-title">Tableau de bord</h1>
                <p class="page-description">Suivi de ton parcours Ã  l'ESME</p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Moyenne GÃ©nÃ©rale</div>
                    <div class="stat-value" id="global-avg" style="color:var(--primary)">â€”</div>
                    <div class="stat-sub">/ 20 Â· pondÃ©rÃ©e</div>
                    <div class="stat-bar"><div class="stat-bar-fill" id="global-bar" style="width:0%"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Notes</div>
                    <div class="stat-value" id="total-grades" style="color:var(--accent)">0</div>
                    <div class="stat-sub">enregistrÃ©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TÃ¢ches</div>
                    <div class="stat-value" id="pending-tasks" style="color:var(--accent-green)">0</div>
                    <div class="stat-sub">en attente</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“… Cours aujourd'hui</div>
                <div class="today-schedule" id="todaySchedule">
                    <div style="padding:32px;text-align:center;color:var(--text-tertiary);">Aucun cours aujourd'hui</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">AperÃ§u UE</div>
                <div class="ue-overview">
                    <div class="ue-card"><div class="ue-code">UE1 Â· 20 ECTS</div><div class="ue-name">Sciences Fond.</div><div class="ue-average" id="dash-ue1">â€”</div></div>
                    <div class="ue-card"><div class="ue-code">UE2 Â· 15 ECTS</div><div class="ue-name">Ã‰nergie & Climat</div><div class="ue-average" id="dash-ue2">â€”</div></div>
                    <div class="ue-card"><div class="ue-code">UE3 Â· 15 ECTS</div><div class="ue-name">Tech. & Langages</div><div class="ue-average" id="dash-ue3">â€”</div></div>
                    <div class="ue-card"><div class="ue-code">UE4 Â· 10 ECTS</div><div class="ue-name">Projet Personnel</div><div class="ue-average" id="dash-ue4">â€”</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">TÃ¢ches & Devoirs</div>
                <div class="form-row" style="margin-bottom:0">
                    <input type="text" id="taskInput" class="input-grow" placeholder="Nouvelle tÃ¢che...">
                    <button class="btn btn-primary" onclick="addTask()">+ Ajouter</button>
                </div>
                <div id="taskList" style="margin-top:16px;"></div>
            </div>
        </section>

        <!-- GRADES -->
        <section id="grades" class="section">
            <div class="page-header">
                <div class="page-meta">Gestion acadÃ©mique</div>
                <h1 class="page-title">Notes & Moyennes</h1>
                <p class="page-description">PondÃ©rÃ© par type d'Ã©valuation</p>
            </div>
            <div class="card">
                <div class="card-title">Ajouter une note</div>
                <div class="grade-form-row1">
                    <select id="gradeUE" onchange="updateModuleSelect()">
                        <option value="ue1">UE1</option><option value="ue2">UE2</option>
                        <option value="ue3">UE3</option><option value="ue4">UE4</option>
                    </select>
                    <input type="number" id="gradeValue" placeholder="Note /20" min="0" max="20" step="0.5">
                </div>
                <div class="grade-form-row2">
                    <select id="gradeSubject" onchange="updateGradeTypeSelect()"><option value="">â€” Module â€”</option></select>
                    <select id="gradeType"><option value="">â€” Type â€”</option></select>
                </div>
                <button class="btn btn-primary btn-full" onclick="addGrade()">+ Enregistrer la note</button>
            </div>
            <div class="scroll-x" style="margin:0 -4px 16px; padding:0 4px 4px;">
                <div class="ue-tabs" style="min-width:max-content;grid-template-columns:repeat(4,200px);">
                    <button class="ue-tab active" onclick="switchUE('ue1',this)">
                        <div class="ue-tab-code">UE1</div><div class="ue-tab-name">Sciences Fondamentales</div><div class="ue-tab-ects">20 ECTS</div>
                    </button>
                    <button class="ue-tab" onclick="switchUE('ue2',this)">
                        <div class="ue-tab-code">UE2</div><div class="ue-tab-name">Ã‰nergie & Climat</div><div class="ue-tab-ects">15 ECTS</div>
                    </button>
                    <button class="ue-tab" onclick="switchUE('ue3',this)">
                        <div class="ue-tab-code">UE3</div><div class="ue-tab-name">Technologies & Langages</div><div class="ue-tab-ects">15 ECTS</div>
                    </button>
                    <button class="ue-tab" onclick="switchUE('ue4',this)">
                        <div class="ue-tab-code">UE4</div><div class="ue-tab-name">Projet Personnel</div><div class="ue-tab-ects">10 ECTS</div>
                    </button>
                </div>
            </div>
            <div class="ue-panel active" id="panel-ue1">
                <div class="card">
                    <div class="card-title">UE1 â€” Sciences fondamentales<span style="margin-left:auto;font-size:1.5rem;font-family:'JetBrains Mono',monospace;" id="avg-ue1">â€”</span></div>
                    <div class="modules-grid" id="modules-ue1"></div>
                </div>
            </div>
            <div class="ue-panel" id="panel-ue2">
                <div class="card">
                    <div class="card-title">UE2 â€” Ã‰nergie - Climat<span style="margin-left:auto;font-size:1.5rem;font-family:'JetBrains Mono',monospace;" id="avg-ue2">â€”</span></div>
                    <div class="modules-grid" id="modules-ue2"></div>
                </div>
            </div>
            <div class="ue-panel" id="panel-ue3">
                <div class="card">
                    <div class="card-title">UE3 â€” Technologies & Langages<span style="margin-left:auto;font-size:1.5rem;font-family:'JetBrains Mono',monospace;" id="avg-ue3">â€”</span></div>
                    <div class="modules-grid" id="modules-ue3"></div>
                </div>
            </div>
            <div class="ue-panel" id="panel-ue4">
                <div class="card">
                    <div class="card-title">UE4 â€” Projet Personnel<span style="margin-left:auto;font-size:1.5rem;font-family:'JetBrains Mono',monospace;" id="avg-ue4">â€”</span></div>
                    <div class="modules-grid" id="modules-ue4"></div>
                </div>
            </div>
        </section>

        <!-- SCHEDULE -->
        <section id="schedule" class="section">
            <div class="page-header">
                <div class="page-meta">Organisation</div>
                <h1 class="page-title">Emploi du temps</h1>
                <p class="page-description">Planification hebdomadaire</p>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“¥ Importer depuis Alcuin (ICS)</div>
                <div class="ics-form-row">
                    <input type="url" id="icsUrl" placeholder="https://connecteur.alcuin.com/ADS/ESME.mvc/api/ics/uuid">
                    <div class="form-row" style="flex-direction:row;">
                        <button class="btn btn-primary" id="importBtn" onclick="importICS()" style="flex:1;">ğŸ“¥ Importer</button>
                        <button class="btn btn-secondary" id="refreshBtn" onclick="refreshICS()" style="display:none;flex:1;">ğŸ”„ Actualiser</button>
                        <button class="btn btn-secondary" onclick="clearSchedule()" style="padding:12px 14px;">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="ics-panel">
                    <div class="ics-status-msg" id="icsStatusMsg">Entrez votre lien ICS Alcuin et cliquez sur Importer.</div>
                    <div class="ics-progress" id="icsProgress">
                        <div class="ics-progress-bar"><div class="ics-progress-fill"></div></div>
                        <div class="ics-status-msg" id="icsProgressMsg">Connexion en cours...</div>
                    </div>
                    <div class="proxy-chips" id="proxyChips"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">âœï¸ Ajouter manuellement</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                    <input type="text" id="schedCourse" placeholder="Cours">
                    <input type="text" id="schedLocation" placeholder="Salle">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
                    <input type="date" id="schedDate">
                    <input type="time" id="schedStart">
                    <input type="time" id="schedEnd">
                </div>
                <button class="btn btn-primary btn-full" onclick="addCourse()">+ Ajouter le cours</button>
            </div>
            <div class="week-nav">
                <button class="btn btn-secondary" onclick="changeWeek(-1)">â†</button>
                <div class="week-info">
                    <div class="week-number" id="weekNum">Semaine â€”</div>
                    <div class="week-dates" id="weekDates">â€”</div>
                    <button class="btn btn-today" id="todayBtn" onclick="goToToday()" style="display:none;">â—‰ Aujourd'hui</button>
                </div>
                <button class="btn btn-secondary" onclick="changeWeek(1)">â†’</button>
            </div>
            <div class="schedule-grid-wrapper scroll-x">
                <div class="schedule-grid" id="scheduleGrid"></div>
            </div>
        </section>

        <!-- RESOURCES -->
        <section id="resources" class="section">
            <div class="page-header">
                <div class="page-meta">BibliothÃ¨que</div>
                <h1 class="page-title">Ressources</h1>
                <p class="page-description">Supports par UE et matiÃ¨re</p>
            </div>
            <div class="card">
                <div class="card-title">Ajouter une ressource</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
                    <select id="resUE" onchange="updateResModuleSelect()">
                        <option value="ue1">UE1</option><option value="ue2">UE2</option>
                        <option value="ue3">UE3</option><option value="ue4">UE4</option>
                    </select>
                    <select id="resModule" style="grid-column:span 2;"><option value="">â€” MatiÃ¨re â€”</option></select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                    <select id="resCategory">
                        <option value="cm">ğŸ“– CM</option><option value="td">âœï¸ TD</option>
                        <option value="tp">ğŸ§ª TP</option><option value="fiche">ğŸ“ Fiche</option>
                        <option value="exam">ğŸ“ Examen</option><option value="autre">ğŸ“ Autre</option>
                    </select>
                    <input type="text" id="resTitle" placeholder="Titre">
                </div>
                <!-- Tabs: lien URL vs upload PDF -->
                <div class="res-input-tabs">
                    <button class="res-input-tab active" onclick="switchResInputTab('url', this)">ğŸ”— Lien URL</button>
                    <button class="res-input-tab" onclick="switchResInputTab('pdf', this)">ğŸ“„ Fichier PDF</button>
                </div>
                <!-- Panel URL -->
                <div class="res-input-panel active" id="res-panel-url">
                    <div style="display:flex;gap:8px;">
                        <input type="url" id="resLink" placeholder="https://..." style="flex:1;">
                        <button class="btn btn-primary" onclick="addResource()" style="white-space:nowrap;">+ Ajouter</button>
                    </div>
                </div>
                <!-- Panel PDF upload -->
                <div class="res-input-panel" id="res-panel-pdf">
                    <div class="pdf-drop-zone" id="pdfDropZone">
                        <input type="file" id="pdfFileInput" accept=".pdf,application/pdf" onchange="handlePDFSelect(this)">
                        <div class="pdf-drop-icon">ğŸ“„</div>
                        <div class="pdf-drop-text">Clique ou glisse ton PDF ici</div>
                        <div class="pdf-drop-sub">Fichiers PDF uniquement Â· max ~4 Mo recommandÃ©</div>
                    </div>
                    <div id="pdfSelectedInfo" style="display:none;" class="pdf-selected">
                        <span>ğŸ“„</span>
                        <span class="pdf-selected-name" id="pdfSelectedName">â€”</span>
                        <span class="pdf-selected-size" id="pdfSelectedSize">â€”</span>
                        <span class="pdf-clear" onclick="clearPDFSelection()" title="Retirer">âœ•</span>
                    </div>
                    <div id="pdfSizeWarn" class="pdf-size-warn" style="display:none;">âš ï¸ Ce fichier est volumineux â€” il peut saturer le stockage local.</div>
                    <div style="margin-top:10px;">
                        <button class="btn btn-primary btn-full" onclick="addResourcePDF()">+ Ajouter le PDF</button>
                    </div>
                </div>
            </div>
            <div class="res-toolbar">
                <div class="res-search-wrap">
                    <span class="res-search-icon">ğŸ”</span>
                    <input type="text" id="resSearch" placeholder="Rechercher..." oninput="renderResources()">
                </div>
            </div>
            <div class="scroll-x" style="margin-bottom:12px;">
                <div class="resource-filters" id="resCatFilters" style="flex-wrap:nowrap;padding-bottom:4px;">
                    <button class="filter-btn active" onclick="filterResources('all',this)">Tout</button>
                    <button class="filter-btn" onclick="filterResources('cm',this)">CM</button>
                    <button class="filter-btn" onclick="filterResources('td',this)">TD</button>
                    <button class="filter-btn" onclick="filterResources('tp',this)">TP</button>
                    <button class="filter-btn" onclick="filterResources('fiche',this)">Fiches</button>
                    <button class="filter-btn" onclick="filterResources('exam',this)">Examens</button>
                    <button class="filter-btn" onclick="filterResources('autre',this)">Autres</button>
                </div>
            </div>
            <div class="scroll-x" style="margin-bottom:20px;">
                <div class="res-ue-tabs" id="resUETabs" style="flex-wrap:nowrap;padding-bottom:4px;">
                    <button class="res-ue-tab active" onclick="filterResUE('all',this)">
                        <span class="res-ue-tab-dot" style="background:var(--primary)"></span>Toutes
                        <span class="res-ue-tab-count" id="res-count-all">0</span>
                    </button>
                    <button class="res-ue-tab" onclick="filterResUE('ue1',this)">
                        <span class="res-ue-tab-dot" style="background:#6366F1"></span>UE1
                        <span class="res-ue-tab-count" id="res-count-ue1">0</span>
                    </button>
                    <button class="res-ue-tab" onclick="filterResUE('ue2',this)">
                        <span class="res-ue-tab-dot" style="background:#06B6D4"></span>UE2
                        <span class="res-ue-tab-count" id="res-count-ue2">0</span>
                    </button>
                    <button class="res-ue-tab" onclick="filterResUE('ue3',this)">
                        <span class="res-ue-tab-dot" style="background:#A855F7"></span>UE3
                        <span class="res-ue-tab-count" id="res-count-ue3">0</span>
                    </button>
                    <button class="res-ue-tab" onclick="filterResUE('ue4',this)">
                        <span class="res-ue-tab-dot" style="background:#F59E0B"></span>UE4
                        <span class="res-ue-tab-count" id="res-count-ue4">0</span>
                    </button>
                </div>
            </div>
            <div id="resourcesList"></div>
        </section>
    </main>

    <!-- â•â•â• MOBILE BOTTOM NAV â•â•â• -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav">
        <button class="mobile-nav-item active" data-section="dashboard" onclick="showSection('dashboard', this)">
            <div class="mobile-nav-icon">â—†</div>
            <div class="mobile-nav-dot"></div>
            <div class="mobile-nav-label">Accueil</div>
        </button>
        <button class="mobile-nav-item" data-section="grades" onclick="showSection('grades', this)">
            <div class="mobile-nav-icon">â—ˆ</div>
            <div class="mobile-nav-dot"></div>
            <div class="mobile-nav-label">Notes</div>
        </button>
        <button class="mobile-nav-item" data-section="schedule" onclick="showSection('schedule', this)">
            <div class="mobile-nav-icon">â—§</div>
            <div class="mobile-nav-dot"></div>
            <div class="mobile-nav-label">Planning</div>
        </button>
        <button class="mobile-nav-item" data-section="resources" onclick="showSection('resources', this)">
            <div class="mobile-nav-icon">â—ª</div>
            <div class="mobile-nav-dot"></div>
            <div class="mobile-nav-label">Ressources</div>
        </button>
    </nav>

    <!-- â•â•â• PDF VIEWER MODAL â•â•â• -->
    <div id="pdfModal">
        <div class="pdf-modal-header">
            <span style="font-size:1.1rem;">ğŸ“„</span>
            <div class="pdf-modal-title" id="pdfModalTitle">Document PDF</div>
            <div class="pdf-modal-actions">
                <a class="pdf-modal-btn" id="pdfModalDownload" href="#" download>â¬‡ TÃ©lÃ©charger</a>
            </div>
            <button class="pdf-modal-close" onclick="closePDFModal()" title="Fermer">âœ•</button>
        </div>
        <div class="pdf-modal-body">
            <div class="pdf-modal-loading" id="pdfModalLoading">
                <div class="pdf-spinner"></div>
                <span>Chargement du PDF...</span>
            </div>
            <iframe id="pdfModalFrame" onload="hidePDFLoading()" style="opacity:0;transition:opacity 0.3s;"></iframe>
        </div>
    </div>

    <div id="toast"></div>

    <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let data = JSON.parse(localStorage.getItem('studentDataV4')) || {
        grades: [], tasks: [], schedule: [], resources: [], icsUrl: ''
    };
    let currentWeek = 0, activeUE = 'ue1', activeFilter = 'all', activeResUE = 'all';

    // Separate storage key for PDF data (can be large)
    // Each PDF is stored as: localStorage['pdfData_<pdfId>'] = base64 string

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       UE MODULES WITH EVAL WEIGHTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const UE_MODULES = {
        ue1: [
            { id:'maths3', name:'MathÃ©matiques fondamentales 3', sem:'S1', coef:1, evals:[{key:'CC',label:'CC',weight:20,color:'#6366F1'},{key:'PrÃ©requis',label:'PrÃ©requis',weight:5,color:'#8B5CF6'},{key:'Quiz',label:'Quiz',weight:10,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'outils3', name:'Outils mathÃ©matiques 3', sem:'S1', coef:1, evals:[{key:'CC',label:'CC',weight:25,color:'#6366F1'},{key:'Quiz',label:'Quiz',weight:10,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'analyse', name:"Introduction Ã  l'analyse numÃ©rique", sem:'S1', coef:1, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'MidtermLab',label:'Midterm Lab',weight:25,color:'#F59E0B'},{key:'FinalLab',label:'Final Lab',weight:40,color:'#EF4444'}] },
            { id:'signaux', name:'Signaux et systÃ¨mes', sem:'S1', coef:1, evals:[{key:'TP',label:'TP',weight:15,color:'#10B981'},{key:'CC',label:'CC',weight:15,color:'#6366F1'},{key:'PrÃ©requis',label:'PrÃ©requis',weight:5,color:'#8B5CF6'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'maths4', name:'MathÃ©matiques fondamentales 4', sem:'S2', coef:1, evals:[{key:'CC',label:'CC',weight:25,color:'#6366F1'},{key:'Quiz',label:'Quiz',weight:10,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'outils4', name:'Outils mathÃ©matiques 4', sem:'S2', coef:1, evals:[{key:'CC',label:'CC',weight:25,color:'#6366F1'},{key:'Quiz',label:'Quiz',weight:10,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'em2', name:'Ã‰lectromagnÃ©tisme 2', sem:'S2', coef:1, evals:[{key:'CC',label:'CC',weight:30,color:'#6366F1'},{key:'PrÃ©requis',label:'PrÃ©requis',weight:5,color:'#8B5CF6'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
        ],
        ue2: [
            { id:'systech3', name:'SystÃ¨mes techniques 3', sem:'S1', coef:2, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:30,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:35,color:'#EF4444'}] },
            { id:'mecafluides', name:'MÃ©canique des fluides', sem:'S1', coef:2, evals:[{key:'CC',label:'CC',weight:35,color:'#6366F1'},{key:'Midterm',label:'Midterm Ex',weight:30,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:35,color:'#EF4444'}] },
            { id:'enviro1', name:'Enjeux Environnementaux 1', sem:'S1', coef:1, evals:[{key:'CC',label:'CC',weight:50,color:'#6366F1'},{key:'Final',label:'Final Ex',weight:50,color:'#EF4444'}] },
            { id:'gprojet1', name:'Gestion de projet : objectifs SMART', sem:'S1', coef:1, evals:[{key:'CC',label:'CC',weight:50,color:'#6366F1'},{key:'Report',label:'Final Report',weight:50,color:'#10B981'}] },
            { id:'systech4', name:'SystÃ¨mes techniques 4', sem:'S2', coef:2, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:30,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:35,color:'#EF4444'}] },
            { id:'ondes', name:'Ondes Ã©lectromagnÃ©tiques', sem:'S2', coef:2, evals:[{key:'CC',label:'CC',weight:35,color:'#6366F1'},{key:'Midterm',label:'Midterm Ex',weight:30,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:35,color:'#EF4444'}] },
            { id:'enviro2', name:'Enjeux Environnementaux 2', sem:'S2', coef:1, evals:[{key:'TableRonde',label:'Table Ronde EE',weight:100,color:'#10B981'}] },
            { id:'gprojet2', name:'Gestion de projet - Ã‰nergie-Climat', sem:'S2', coef:1, evals:[{key:'CC',label:'CC',weight:30,color:'#6366F1'},{key:'Report',label:'Final Report',weight:30,color:'#10B981'},{key:'Oral',label:'Oral Projet',weight:40,color:'#F59E0B'}] },
            { id:'ihm', name:'Applications avec les IHM', sem:'S2', coef:1, evals:[{key:'Lab',label:'Lab',weight:50,color:'#06B6D4'},{key:'Projet',label:'Projet',weight:50,color:'#10B981'}] },
        ],
        ue3: [
            { id:'elec1', name:'Ã‰lectronique analogique 1', sem:'S1', coef:2, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'algo2', name:'Algorithmique avancÃ©e 2', sem:'S1', coef:2, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'MidtermLab',label:'Midterm Lab',weight:25,color:'#F59E0B'},{key:'FinalLab',label:'Final Lab',weight:40,color:'#EF4444'}] },
            { id:'anglais3', name:'Anglais 3', sem:'S1', coef:1, evals:[{key:'LRSW',label:'LRSW',weight:50,color:'#6366F1'},{key:'Projet',label:'Projects',weight:50,color:'#10B981'}] },
            { id:'lv23', name:'LV2 3', sem:'S1', coef:0, evals:[{key:'ECHOS',label:'Points ECHOS',weight:100,color:'#A855F7'}] },
            { id:'elec2', name:'Ã‰lectronique analogique 2', sem:'S2', coef:2, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'Midterm',label:'Midterm Ex',weight:25,color:'#F59E0B'},{key:'Final',label:'Final Ex',weight:40,color:'#EF4444'}] },
            { id:'algo3', name:'Algorithmique avancÃ©e 3', sem:'S2', coef:2, evals:[{key:'Lab',label:'Lab',weight:20,color:'#06B6D4'},{key:'Quiz',label:'Quiz',weight:15,color:'#A855F7'},{key:'MidtermLab',label:'Midterm Lab',weight:25,color:'#F59E0B'},{key:'FinalLab',label:'Final Lab',weight:40,color:'#EF4444'}] },
            { id:'anglais4', name:'Anglais 4', sem:'S2', coef:2, evals:[{key:'LRSW',label:'LRSW',weight:25,color:'#6366F1'},{key:'IELTS',label:'Intro IELTS',weight:25,color:'#8B5CF6'},{key:'Intensif',label:'Intensive wk',weight:30,color:'#A855F7'},{key:'Final',label:'Final Ex',weight:20,color:'#EF4444'}] },
            { id:'lv24', name:'LV2 4', sem:'S2', coef:0, evals:[{key:'ECHOS',label:'Points ECHOS',weight:100,color:'#A855F7'}] },
        ],
        ue4: [
            { id:'devperso', name:'DÃ©veloppement personnel', sem:'S1', coef:1, evals:[{key:'CC',label:'CC',weight:100,color:'#6366F1'}] },
            { id:'gestion1', name:"Gestion de l'entreprise 1", sem:'S1', coef:1, evals:[{key:'CC',label:'CC',weight:100,color:'#6366F1'}] },
            { id:'parcours2', name:"Parcours d'ouverture 2", sem:'S1', coef:3, evals:[{key:'CC',label:'CC',weight:100,color:'#6366F1'}] },
            { id:'gestion2', name:"Gestion de l'entreprise 2", sem:'S2', coef:1, evals:[{key:'CC',label:'CC',weight:100,color:'#6366F1'}] },
            { id:'parcours3', name:"Parcours d'ouverture 3", sem:'S2', coef:3, evals:[{key:'CC',label:'CC',weight:100,color:'#6366F1'}] },
            { id:'stage', name:'Stage IngÃ©SUP 4 Ã  8 semaines', sem:'S2', coef:4, evals:[{key:'Rapport',label:'Rapport & Eval MaÃ®tre Stage',weight:100,color:'#10B981'}] },
            { id:'echos', name:'ECHOS', sem:'S2', coef:1, evals:[{key:'ECHOS',label:'Valorisation Engagements',weight:100,color:'#A855F7'}] },
        ],
    };

    const RESOURCE_CATEGORIES = {
        cm:{icon:'ğŸ“–',color:'#6366F1',label:'CM'}, td:{icon:'âœï¸',color:'#8B5CF6',label:'TD'},
        tp:{icon:'ğŸ§ª',color:'#06B6D4',label:'TP'}, fiche:{icon:'ğŸ“',color:'#F59E0B',label:'Fiche'},
        exam:{icon:'ğŸ“',color:'#EF4444',label:'Examen'}, autre:{icon:'ğŸ“',color:'#6B7280',label:'Autre'}
    };
    const UE_COLORS = {ue1:'#6366F1',ue2:'#06B6D4',ue3:'#A855F7',ue4:'#F59E0B'};
    const UE_NAMES = {ue1:'Sciences Fondamentales',ue2:'Ã‰nergie & Climat',ue3:'Technologies & Langages',ue4:'Projet Personnel'};

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HELPERS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function buildEvalWeightBar(evals) {
        return evals.map(e => {
            const label = e.weight >= 15 ? `${e.weight}%` : '';
            return `<div class="eval-weight-seg" style="width:${e.weight}%;background:${e.color};" title="${e.label}: ${e.weight}%">${label}</div>`;
        }).join('');
    }
    function calcWeightedAvg(grades, evals) {
        if (!grades.length) return null;
        let totalWeight = 0, weightedSum = 0;
        evals.forEach(e => {
            const matching = grades.filter(g => g.type === e.key);
            if (matching.length > 0) { const avg = matching.reduce((s,g)=>s+g.value,0)/matching.length; weightedSum+=avg*e.weight; totalWeight+=e.weight; }
        });
        if (totalWeight === 0) { const avg = grades.reduce((s,g)=>s+g.value,0)/grades.length; return {avg:avg.toFixed(2),weighted:false}; }
        return {avg:(weightedSum/totalWeight).toFixed(2),weighted:true};
    }
    function getGradeClass(v) { return v>=14?'high':v>=10?'mid':'low'; }
    function getBarColor(v) { return v>=14?'var(--accent-green)':v>=10?'var(--accent)':'var(--accent-red)'; }
    function toLocalDateString(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function toLocalTimeString(d) { return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function formatDate(d) { return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`; }
    function formatBytes(bytes) {
        if (bytes < 1024) return bytes + ' o';
        if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' Ko';
        return (bytes/(1024*1024)).toFixed(1) + ' Mo';
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NAVIGATION
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        const desktopBtn = document.querySelector(`.nav-btn[onclick*="${id}"]`);
        if (desktopBtn) desktopBtn.classList.add('active');
        document.querySelectorAll('.mobile-nav-item').forEach(b=>b.classList.remove('active'));
        const mobileBtn = document.querySelector(`.mobile-nav-item[data-section="${id}"]`);
        if (mobileBtn) mobileBtn.classList.add('active');
        window.scrollTo({top:0,behavior:'smooth'});
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       THEME
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let theme = localStorage.getItem('theme') || 'dark';
    function applyTheme() {
        document.documentElement.setAttribute('data-theme', theme);
        const isDark = theme === 'dark';
        document.getElementById('theme-icon').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
        document.getElementById('theme-text').textContent = isDark ? 'Mode Sombre' : 'Mode Clair';
        document.getElementById('topbar-theme-icon').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
        document.querySelector('meta[name="theme-color"]').content = isDark ? '#0F0F14' : '#F0F2F8';
    }
    function toggleTheme() {
        theme = theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', theme);
        applyTheme();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let toastTimer;
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GRADES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function updateGradeTypeSelect() {
        const ueId=document.getElementById('gradeUE').value, moduleId=document.getElementById('gradeSubject').value;
        const sel=document.getElementById('gradeType'); sel.innerHTML='<option value="">â€” Type â€”</option>';
        if (!moduleId) return;
        const mod=UE_MODULES[ueId]?.find(m=>m.id===moduleId);
        if (!mod) return;
        mod.evals.forEach(e=>{sel.innerHTML+=`<option value="${e.key}">${e.label} (${e.weight}%)</option>`;});
    }
    function updateModuleSelect() {
        const ueId=document.getElementById('gradeUE').value, sel=document.getElementById('gradeSubject');
        sel.innerHTML='<option value="">â€” Module â€”</option>';
        UE_MODULES[ueId].forEach(m=>{sel.innerHTML+=`<option value="${m.id}">${m.name}</option>`;});
        document.getElementById('gradeType').innerHTML='<option value="">â€” Type â€”</option>';
    }
    document.getElementById('gradeUE').addEventListener('change', updateModuleSelect);
    function addGrade() {
        const ueId=document.getElementById('gradeUE').value, moduleId=document.getElementById('gradeSubject').value;
        const value=parseFloat(document.getElementById('gradeValue').value), type=document.getElementById('gradeType').value;
        if (moduleId&&type&&!isNaN(value)&&value>=0&&value<=20) {
            const mod=UE_MODULES[ueId].find(m=>m.id===moduleId);
            data.grades.push({ueId,moduleId,moduleName:mod.name,value,type});
            document.getElementById('gradeValue').value=''; saveData(); showToast('âœ“ Note ajoutÃ©e');
        } else { showToast('âš ï¸ Remplis tous les champs'); }
    }
    function deleteGrade(idx) { data.grades.splice(idx,1); saveData(); showToast('âœ“ Note supprimÃ©e'); }
    function switchUE(ueId, btn) {
        activeUE=ueId;
        document.querySelectorAll('.ue-tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.ue-panel').forEach(p=>p.classList.remove('active'));
        btn.closest('.ue-tab').classList.add('active');
        document.getElementById('panel-'+ueId).classList.add('active');
        document.getElementById('gradeUE').value=ueId; updateModuleSelect();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TASKS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function addTask() {
        const text=document.getElementById('taskInput').value.trim();
        if (text){data.tasks.push({text,done:false});document.getElementById('taskInput').value='';saveData();showToast('âœ“ TÃ¢che ajoutÃ©e');}
    }
    document.getElementById('taskInput').addEventListener('keypress', e=>{if(e.key==='Enter')addTask();});
    function toggleTask(idx){data.tasks[idx].done=!data.tasks[idx].done;saveData();}
    function deleteTask(idx){data.tasks.splice(idx,1);saveData();}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ICS IMPORT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const CORS_PROXIES = [
        url=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        url=>`https://corsproxy.io/?${encodeURIComponent(url)}`,
        url=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
    ];
    const PROXY_NAMES = ['allorigins','corsproxy.io','codetabs'];
    function setICSStatus(msg,type=''){const el=document.getElementById('icsStatusMsg');el.textContent=msg;el.className='ics-status-msg'+(type?' ics-status-'+type:'');}
    function showProgress(show){document.getElementById('icsProgress').style.display=show?'block':'none';document.getElementById('importBtn').disabled=show;}
    function updateProxyChip(idx,state){const chip=document.getElementById('proxyChips').children[idx];if(chip)chip.className='proxy-chip '+state;}
    function initProxyChips(){document.getElementById('proxyChips').innerHTML=PROXY_NAMES.map(n=>`<div class="proxy-chip">${n}</div>`).join('');}
    async function tryFetchICS(url) {
        initProxyChips();
        for (let i=0;i<CORS_PROXIES.length;i++) {
            updateProxyChip(i,'trying');
            document.getElementById('icsProgressMsg').textContent=`Tentative via ${PROXY_NAMES[i]}...`;
            try {
                const controller=new AbortController();const timeout=setTimeout(()=>controller.abort(),10000);
                const response=await fetch(CORS_PROXIES[i](url),{signal:controller.signal});clearTimeout(timeout);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text=await response.text();if(!text.includes('BEGIN:VCALENDAR'))throw new Error('Pas un ICS');
                updateProxyChip(i,'ok');return text;
            } catch(err){updateProxyChip(i,'fail');}
        }
        throw new Error('Tous les proxies ont Ã©chouÃ©.');
    }
    function parseICS(icsText) {
        const unfolded=icsText.replace(/\r?\n[ \t]/g,'');const lines=unfolded.split(/\r?\n/);
        const events=[];let current=null;
        for (const rawLine of lines) {
            const line=rawLine.trim();
            if (line==='BEGIN:VEVENT'){current={};continue;}
            if (line==='END:VEVENT'){if(current?.dtstart&&current?.summary){const p=buildEvent(current);if(p)events.push(p);}current=null;continue;}
            if (!current) continue;
            const ci=line.indexOf(':');if(ci===-1)continue;
            const keyPart=line.substring(0,ci).toUpperCase(),value=line.substring(ci+1);
            const baseKey=keyPart.split(';')[0],params=keyPart.includes(';')?keyPart.substring(keyPart.indexOf(';')+1):'';
            switch(baseKey){case 'DTSTART':current.dtstart=value;current.dtstartParams=params;break;case 'DTEND':current.dtend=value;current.dtendParams=params;break;case 'SUMMARY':current.summary=decodeICSText(value);break;case 'LOCATION':current.location=decodeICSText(value);break;}
        }
        return events;
    }
    function decodeICSText(t){return t.replace(/\\n/g,' ').replace(/\\,/g,',').replace(/\\;/g,';').replace(/\\\\/g,'\\').trim();}
    function buildEvent(evt) {
        try {
            const start=parseICSDate(evt.dtstart,evt.dtstartParams);if(!start)return null;
            const end=evt.dtend?parseICSDate(evt.dtend,evt.dtendParams):null;
            const endDate=end||new Date(start.getTime()+3600000);
            return{course:cleanCourseName(evt.summary),date:toLocalDateString(start),timeStart:toLocalTimeString(start),timeEnd:toLocalTimeString(endDate),location:evt.location||''};
        }catch{return null;}
    }
    function parseICSDate(dateStr,params) {
        if(!dateStr)return null;const isUTC=dateStr.endsWith('Z');const clean=dateStr.replace('Z','');
        const year=parseInt(clean.substring(0,4),10),month=parseInt(clean.substring(4,6),10)-1,day=parseInt(clean.substring(6,8),10);
        let hour=0,minute=0,second=0;
        if(clean.length>8&&clean.includes('T')){const tp=clean.substring(clean.indexOf('T')+1);hour=parseInt(tp.substring(0,2),10)||0;minute=parseInt(tp.substring(2,4),10)||0;second=parseInt(tp.substring(4,6),10)||0;}
        if(isNaN(year)||isNaN(month)||isNaN(day))return null;
        return isUTC?new Date(Date.UTC(year,month,day,hour,minute,second)):new Date(year,month,day,hour,minute,second);
    }
    function cleanCourseName(s) {
        if(!s)return 'Cours sans titre';
        let n=s.trim().replace(/^[A-Z_]+\s*-\s*/i,'').replace(/\s*\[(?:TD|CM|TP|DS|CC|EXAM|COURS|AMPHI)[^\]]*\]/gi,'').replace(/^[A-Z]{2,4}\d{3,4}\s*-?\s*/i,'').replace(/\s*[-â€“]?\s*G(?:roupe)?\s*\d+/gi,'').replace(/\s*[-â€“]?\s*gr\.?\s*\d+/gi,'').replace(/\s+/g,' ').trim();
        return n||s.trim();
    }
    async function importICS() {
        const url=document.getElementById('icsUrl').value.trim();
        if(!url||!url.startsWith('http')){setICSStatus('âŒ URL invalide.','err');return;}
        showProgress(true);setICSStatus('ğŸ“¡ Connexion Ã  Alcuin...');
        try {
            const icsText=await tryFetchICS(url);document.getElementById('icsProgressMsg').textContent='Analyse...';
            const events=parseICS(icsText);
            if(!events.length){showProgress(false);setICSStatus('âš ï¸ Aucun cours trouvÃ©.','warn');return;}
            let added=0,skipped=0;
            events.forEach(e=>{const exists=data.schedule.some(c=>c.date===e.date&&c.timeStart===e.timeStart&&c.course===e.course);if(!exists){data.schedule.push(e);added++;}else skipped++;});
            data.icsUrl=url;showProgress(false);
            setICSStatus(`âœ“ ${added} cours ajoutÃ©s${skipped>0?`, ${skipped} doublons ignorÃ©s`:''}.`,'ok');
            document.getElementById('refreshBtn').style.display='inline-flex';
            saveData();showToast(`âœ“ ${added} cours importÃ©s !`);
        }catch(err){showProgress(false);setICSStatus(`âŒ ${err.message}`,'err');}
    }
    function refreshICS(){if(data.icsUrl){document.getElementById('icsUrl').value=data.icsUrl;data.schedule=data.schedule.filter(c=>c._manual);importICS();}}
    function updateICSStatus(){const rb=document.getElementById('refreshBtn');if(data.icsUrl){if(!document.getElementById('icsUrl').value)document.getElementById('icsUrl').value=data.icsUrl;rb.style.display='inline-flex';setICSStatus(`âœ“ ${data.schedule.length} cours enregistrÃ©s.`,'ok');}else{setICSStatus('Entrez votre lien ICS Alcuin et importez.');}}
    function clearSchedule(){if(confirm('Effacer tout ?')){data.schedule=[];data.icsUrl='';document.getElementById('icsUrl').value='';document.getElementById('refreshBtn').style.display='none';document.getElementById('proxyChips').innerHTML='';setICSStatus('Planning effacÃ©.');saveData();showToast('âœ“ Planning effacÃ©');}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCHEDULE RENDER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function getMonday(d){const date=new Date(d);const day=date.getDay();const diff=date.getDate()-day+(day===0?-6:1);return new Date(date.setDate(diff));}
    function getWeekDates(offset=0){const monday=getMonday(new Date());monday.setDate(monday.getDate()+offset*7);return Array.from({length:5},(_,i)=>{const d=new Date(monday);d.setDate(monday.getDate()+i);return d;});}
    function changeWeek(offset){currentWeek+=offset;renderSchedule();}
    function goToToday(){currentWeek=0;renderSchedule();}
    function addCourse(){
        const course=document.getElementById('schedCourse').value.trim(),date=document.getElementById('schedDate').value,start=document.getElementById('schedStart').value,end=document.getElementById('schedEnd').value,location=document.getElementById('schedLocation').value.trim();
        if(course&&date&&start&&end){data.schedule.push({course,date,timeStart:start,timeEnd:end,location,_manual:true});['schedCourse','schedDate','schedStart','schedEnd','schedLocation'].forEach(id=>document.getElementById(id).value='');saveData();showToast('âœ“ Cours ajoutÃ©');}
    }
    function deleteCourse(idx){data.schedule.splice(idx,1);saveData();showToast('âœ“ Cours supprimÃ©');}
    function renderSchedule(){
        const dates=getWeekDates(currentWeek);const days=['Lun','Mar','Mer','Jeu','Ven'];
        const d=new Date(dates[0]);const dayOfYear=Math.floor((d-new Date(d.getFullYear(),0,1))/86400000);
        const weekNum=Math.ceil((dayOfYear+new Date(d.getFullYear(),0,1).getDay()+1)/7);
        document.getElementById('weekNum').textContent=`Semaine ${weekNum}`;
        document.getElementById('weekDates').textContent=`${formatDate(dates[0])} â€“ ${formatDate(dates[4])}`;
        const tb=document.getElementById('todayBtn');if(tb)tb.style.display=currentWeek!==0?'inline-flex':'none';
        const grid=document.getElementById('scheduleGrid');grid.innerHTML='';
        dates.forEach((date,i)=>{
            const dateStr=toLocalDateString(date);
            const courses=data.schedule.filter(c=>c.date===dateStr).sort((a,b)=>a.timeStart.localeCompare(b.timeStart));
            let body=courses.length===0?'<div style="padding:16px;text-align:center;color:var(--text-tertiary);font-size:0.75rem;">Libre</div>':courses.map(c=>{const idx=data.schedule.indexOf(c);return`<div class="course-slot" onclick="deleteCourse(${idx})" title="Supprimer"><div class="course-time">${c.timeStart}â€“${c.timeEnd}</div><div class="course-name">${c.course}</div>${c.location?`<div class="course-loc">ğŸ“${c.location}</div>`:''}</div>`;}).join('');
            const isToday=toLocalDateString(date)===toLocalDateString(new Date());
            grid.innerHTML+=`<div class="day-column" ${isToday?'style="border-color:var(--primary);"':''}><div class="day-header" ${isToday?'style="background:rgba(99,102,241,0.1);"':''}><div class="day-name">${days[i]}</div><div class="day-date">${formatDate(date)}</div></div><div class="day-body">${body}</div></div>`;
        });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TODAY SCHEDULE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderTodaySchedule(){
        const container=document.getElementById('todaySchedule');if(!container)return;
        const todayStr=toLocalDateString(new Date());
        const courses=data.schedule.filter(c=>c.date===todayStr).sort((a,b)=>a.timeStart.localeCompare(b.timeStart));
        if(!courses.length){container.innerHTML='<div style="padding:32px;text-align:center;color:var(--text-tertiary);">Aucun cours aujourd\'hui</div>';return;}
        const now=new Date();const currentMinutes=now.getHours()*60+now.getMinutes();
        let nextFound=false;let html='';
        courses.forEach(c=>{
            const [sH,sM]=c.timeStart.split(':').map(Number);const [eH,eM]=c.timeEnd.split(':').map(Number);
            const startMin=sH*60+sM,endMin=eH*60+eM,until=startMin-currentMinutes;
            let badge='',itemClass='';
            if(currentMinutes>=startMin&&currentMinutes<endMin){badge=`<span class="time-badge current">ğŸ”´ EN COURS</span>`;itemClass='current';}
            else if(until>0&&until<=60&&!nextFound){badge=until<10?`<span class="time-badge soon">âš ï¸ ${until} min</span>`:`<span class="time-badge upcoming">â° ${until} min</span>`;itemClass='next';nextFound=true;}
            else if(until>60){const h=Math.floor(until/60),m=until%60;badge=`<span class="time-badge later">Dans ${h}h${m>0?String(m).padStart(2,'0'):''}</span>`;}
            html+=`<div class="course-item ${itemClass}"><div class="course-time-block"><div class="course-start">${c.timeStart}</div><div class="course-end">${c.timeEnd}</div></div><div class="course-details"><div class="course-header"><div class="course-title-text">${c.course}</div>${badge}</div>${c.location?`<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:3px;">ğŸ“ ${c.location}</div>`:''}</div></div>`;
        });
        container.innerHTML=html;setTimeout(renderTodaySchedule,60000);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESOURCES â€” INPUT TABS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let currentResInputMode = 'url';
    let pendingPDFData = null; // { base64, name, size }

    function switchResInputTab(mode, btn) {
        currentResInputMode = mode;
        document.querySelectorAll('.res-input-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.res-input-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('res-panel-' + mode).classList.add('active');
    }

    /* â”€â”€â”€ PDF FILE SELECTION â”€â”€â”€ */
    function handlePDFSelect(input) {
        const file = input.files[0];
        if (!file) return;
        if (file.type !== 'application/pdf' && !file.name.endsWith('.pdf')) {
            showToast('âš ï¸ Seulement les fichiers PDF sont acceptÃ©s');
            input.value = ''; return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            pendingPDFData = { base64: e.target.result, name: file.name, size: file.size };
            document.getElementById('pdfSelectedInfo').style.display = 'flex';
            document.getElementById('pdfSelectedName').textContent = file.name;
            document.getElementById('pdfSelectedSize').textContent = formatBytes(file.size);
            document.getElementById('pdfDropZone').style.display = 'none';
            document.getElementById('pdfSizeWarn').style.display = file.size > 2*1024*1024 ? 'block' : 'none';
        };
        reader.readAsDataURL(file);
    }

    // Drag & drop support
    const dropZone = document.getElementById('pdfDropZone');
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault(); dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) { const fakeInput = { files: [file] }; handlePDFSelect(fakeInput); }
    });

    function clearPDFSelection() {
        pendingPDFData = null;
        document.getElementById('pdfSelectedInfo').style.display = 'none';
        document.getElementById('pdfDropZone').style.display = 'block';
        document.getElementById('pdfSizeWarn').style.display = 'none';
        document.getElementById('pdfFileInput').value = '';
    }

    /* â”€â”€â”€ ADD RESOURCE (URL) â”€â”€â”€ */
    function addResource() {
        const ueId=document.getElementById('resUE').value, moduleId=document.getElementById('resModule').value;
        const category=document.getElementById('resCategory').value, title=document.getElementById('resTitle').value.trim();
        const link=document.getElementById('resLink').value.trim();
        if(!moduleId){showToast('âš ï¸ SÃ©lectionne une matiÃ¨re');return;}
        if(!title){showToast('âš ï¸ Entre un titre');return;}
        if(!link){showToast('âš ï¸ Entre un lien');return;}
        const mod=UE_MODULES[ueId].find(m=>m.id===moduleId);
        data.resources.push({ueId,moduleId,moduleName:mod.name,category,title,link,type:'url'});
        document.getElementById('resTitle').value='';document.getElementById('resLink').value='';
        saveData();showToast('âœ“ Ressource ajoutÃ©e');
    }

    /* â”€â”€â”€ ADD RESOURCE (PDF) â”€â”€â”€ */
    function addResourcePDF() {
        const ueId=document.getElementById('resUE').value, moduleId=document.getElementById('resModule').value;
        const category=document.getElementById('resCategory').value, title=document.getElementById('resTitle').value.trim();
        if(!moduleId){showToast('âš ï¸ SÃ©lectionne une matiÃ¨re');return;}
        if(!title){showToast('âš ï¸ Entre un titre');return;}
        if(!pendingPDFData){showToast('âš ï¸ SÃ©lectionne un fichier PDF');return;}
        const mod=UE_MODULES[ueId].find(m=>m.id===moduleId);
        // Generate unique ID for the PDF
        const pdfId = 'pdf_' + Date.now() + '_' + Math.random().toString(36).substr(2,6);
        // Store PDF data separately to avoid blowing up the main data object
        try {
            localStorage.setItem(pdfId, pendingPDFData.base64);
        } catch(e) {
            showToast('âŒ Stockage insuffisant â€” fichier trop volumineux');
            return;
        }
        data.resources.push({ueId,moduleId,moduleName:mod.name,category,title,type:'pdf',pdfId,pdfName:pendingPDFData.name,pdfSize:pendingPDFData.size});
        document.getElementById('resTitle').value='';
        clearPDFSelection();
        saveData();showToast('âœ“ PDF ajoutÃ©');
    }

    /* â”€â”€â”€ DELETE RESOURCE â”€â”€â”€ */
    function deleteResource(idx) {
        const r = data.resources[idx];
        if (r.type === 'pdf' && r.pdfId) {
            localStorage.removeItem(r.pdfId);
        }
        data.resources.splice(idx,1);
        saveData();showToast('âœ“ Ressource supprimÃ©e');
    }

    /* â”€â”€â”€ OPEN PDF â”€â”€â”€ */
    function openPDF(pdfId, title) {
        const b64 = localStorage.getItem(pdfId);
        if (!b64) { showToast('âŒ PDF introuvable dans le stockage'); return; }
        const modal = document.getElementById('pdfModal');
        const frame = document.getElementById('pdfModalFrame');
        const loading = document.getElementById('pdfModalLoading');
        document.getElementById('pdfModalTitle').textContent = title;
        // Show loading
        loading.style.display = 'flex';
        frame.style.opacity = '0';
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
        // Set download link
        const dlLink = document.getElementById('pdfModalDownload');
        dlLink.href = b64;
        dlLink.download = title + '.pdf';
        // Load PDF in iframe
        frame.src = b64;
    }

    function hidePDFLoading() {
        document.getElementById('pdfModalLoading').style.display = 'none';
        document.getElementById('pdfModalFrame').style.opacity = '1';
    }

    function closePDFModal() {
        const modal = document.getElementById('pdfModal');
        modal.classList.remove('open');
        document.body.style.overflow = '';
        // Clear iframe src to free memory
        setTimeout(() => { document.getElementById('pdfModalFrame').src = ''; }, 300);
    }

    // Close modal on Escape key
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePDFModal(); });

    function filterResources(category,btn){activeFilter=category;document.querySelectorAll('#resCatFilters .filter-btn').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');renderResources();}
    function filterResUE(ueId,btn){activeResUE=ueId;document.querySelectorAll('.res-ue-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');renderResources();}
    function toggleResUEBlock(ueId){document.getElementById('res-ue-block-'+ueId)?.classList.toggle('collapsed');}
    function toggleResModuleBlock(id){document.getElementById(id)?.classList.toggle('collapsed');}

    function updateResModuleSelect(){
        const ueId=document.getElementById('resUE').value,sel=document.getElementById('resModule');
        sel.innerHTML='<option value="">â€” MatiÃ¨re â€”</option>';
        UE_MODULES[ueId].forEach(m=>{sel.innerHTML+=`<option value="${m.id}">${m.name}</option>`;});
    }

    function renderResources(){
        const list=document.getElementById('resourcesList');if(!list)return;
        const searchVal=(document.getElementById('resSearch')?.value||'').toLowerCase();
        let filtered=data.resources.map((r,idx)=>({...r,_idx:idx}));
        if(activeResUE!=='all')filtered=filtered.filter(r=>r.ueId===activeResUE);
        if(activeFilter!=='all')filtered=filtered.filter(r=>r.category===activeFilter);
        if(searchVal)filtered=filtered.filter(r=>r.title.toLowerCase().includes(searchVal)||(r.moduleName||'').toLowerCase().includes(searchVal));
        ['all','ue1','ue2','ue3','ue4'].forEach(ueId=>{const el=document.getElementById('res-count-'+ueId);if(!el)return;el.textContent=data.resources.filter(r=>ueId==='all'||r.ueId===ueId).length;});
        if(!filtered.length){list.innerHTML='<div class="res-empty-ue"><div class="res-empty-ue-icon">ğŸ“­</div><div class="res-empty-ue-text">Aucune ressource</div></div>';return;}
        const ueOrder=['ue1','ue2','ue3','ue4'];const byUE={};
        ueOrder.forEach(ueId=>{byUE[ueId]={};});
        filtered.forEach(r=>{const ueId=r.ueId||'ue1';const modId=r.moduleId||'__none__';if(!byUE[ueId])byUE[ueId]={};if(!byUE[ueId][modId])byUE[ueId][modId]=[];byUE[ueId][modId].push(r);});
        let html='';
        ueOrder.forEach(ueId=>{
            const mods=byUE[ueId];if(!Object.keys(mods).length)return;
            const color=UE_COLORS[ueId],ueName=UE_NAMES[ueId],ueCount=Object.values(mods).flat().length;
            html+=`<div class="res-ue-block" id="res-ue-block-${ueId}"><div class="res-ue-header" onclick="toggleResUEBlock('${ueId}')"><div class="res-ue-stripe" style="background:${color};"></div><div class="res-ue-header-info"><div class="res-ue-header-code" style="color:${color};">${ueId.toUpperCase()}</div><div class="res-ue-header-name">${ueName}</div></div><div class="res-ue-header-stats"><span class="res-ue-badge">${ueCount} doc${ueCount>1?'s':''}</span></div><span class="res-ue-chevron">â–¼</span></div><div class="res-ue-body">`;
            const modOrder=UE_MODULES[ueId].map(m=>m.id);
            Object.keys(mods).sort((a,b)=>(modOrder.indexOf(a)===-1?999:modOrder.indexOf(a))-(modOrder.indexOf(b)===-1?999:modOrder.indexOf(b))).forEach(modId=>{
                const items=mods[modId];const modInfo=UE_MODULES[ueId]?.find(m=>m.id===modId);const modName=modInfo?.name||items[0]?.moduleName||'Autre';const modSem=modInfo?.sem||'';
                const initials=modName.split(' ').filter(w=>w.length>2).slice(0,2).map(w=>w[0].toUpperCase()).join('')||modName.substring(0,2).toUpperCase();
                const blockId=`res-mod-${ueId}-${modId}`;
                html+=`<div class="res-module-block" id="${blockId}"><div class="res-module-header" onclick="toggleResModuleBlock('${blockId}')"><div class="res-module-icon" style="background:${color};">${initials}</div><div class="res-module-name">${modName}</div>${modSem?`<div class="res-module-sem">${modSem}</div>`:''}<div class="res-module-count">${items.length} doc${items.length>1?'s':''}</div><span class="res-module-chevron">â–¾</span></div><div class="res-module-body">`;
                items.forEach(r=>{
                    const cat=RESOURCE_CATEGORIES[r.category]||RESOURCE_CATEGORIES.autre;
                    // Determine open button based on type
                    let openBtn = '';
                    if (r.type === 'pdf' && r.pdfId) {
                        const sizeLabel = r.pdfSize ? ` Â· ${formatBytes(r.pdfSize)}` : '';
                        openBtn = `<button class="res-row-pdf" onclick="openPDF('${r.pdfId}', ${JSON.stringify(r.title)})" title="Ouvrir le PDF">ğŸ“„ Ouvrir${sizeLabel}</button>`;
                    } else if (r.link) {
                        openBtn = `<a class="res-row-open" href="${r.link}" target="_blank" rel="noopener">â†— Ouvrir</a>`;
                    }
                    html+=`<div class="res-row"><span class="res-cat-pill" style="background:${cat.color}20;color:${cat.color};border:1px solid ${cat.color}40;">${cat.icon} ${cat.label}</span><span class="res-row-title" title="${r.title}">${r.title}</span>${openBtn}<button class="btn btn-danger" onclick="deleteResource(${r._idx})" style="padding:5px 9px;font-size:0.7rem;min-height:32px;">âœ•</button></div>`;
                });
                html+=`</div></div>`;
            });
            html+=`</div></div>`;
        });
        list.innerHTML=html;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SAVE & REFRESH UI
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function saveData(){localStorage.setItem('studentDataV4',JSON.stringify(data));refreshUI();}
    function refreshUI(){
        const ueAverages={};let grandTotal=0,grandCount=0;
        ['ue1','ue2','ue3','ue4'].forEach(ueId=>{
            let totalW=0,totalCoef=0;
            UE_MODULES[ueId].forEach(mod=>{
                if(mod.coef===0)return;
                const grades=data.grades.filter(g=>g.ueId===ueId&&g.moduleId===mod.id);
                if(grades.length>0){const result=calcWeightedAvg(grades,mod.evals);const avg=parseFloat(result.avg);totalW+=avg*mod.coef;totalCoef+=mod.coef;}
            });
            ueAverages[ueId]=totalCoef>0?(totalW/totalCoef).toFixed(2):null;
            if(totalCoef>0){grandTotal+=totalW/totalCoef;grandCount++;}
        });
        const globalAvg=grandCount>0?(grandTotal/grandCount).toFixed(2):null;
        document.getElementById('global-avg').textContent=globalAvg||'â€”';
        document.getElementById('global-bar').style.width=globalAvg?`${(globalAvg/20)*100}%`:'0%';
        document.getElementById('total-grades').textContent=data.grades.length;
        document.getElementById('pending-tasks').textContent=data.tasks.filter(t=>!t.done).length;
        ['ue1','ue2','ue3','ue4'].forEach(ueId=>{
            const avg=ueAverages[ueId];
            ['dash-','avg-'].forEach(prefix=>{
                const el=document.getElementById(prefix+ueId);if(!el)return;
                el.textContent=prefix==='avg-'?(avg?`${avg} /20`:'â€”'):(avg||'â€”');
                el.style.color=avg?getBarColor(parseFloat(avg)):'var(--text-tertiary)';
            });
        });
        renderTodaySchedule();
        ['ue1','ue2','ue3','ue4'].forEach(ueId=>{
            const container=document.getElementById('modules-'+ueId);if(!container)return;
            container.innerHTML='';
            UE_MODULES[ueId].forEach(mod=>{
                const grades=data.grades.map((g,idx)=>({...g,idx})).filter(g=>g.ueId===ueId&&g.moduleId===mod.id);
                let chips='';
                if(grades.length===0){chips='<span style="color:var(--text-tertiary);font-size:0.78rem;">Aucune note</span>';}
                else{grades.forEach(g=>{chips+=`<span class="grade-chip ${getGradeClass(g.value)}"><span class="grade-type">${g.type}</span><span>${g.value}</span><span class="grade-del" onclick="deleteGrade(${g.idx})">âœ•</span></span>`;});}
                const result=grades.length?calcWeightedAvg(grades,mod.evals):null;
                const avgD=result?result.avg:'â€”';const color=result?getBarColor(parseFloat(result.avg)):'var(--border)';const barW=result?`${(parseFloat(result.avg)/20)*100}%`:'0%';
                container.innerHTML+=`<div class="module-card"><div class="module-header"><div class="module-name">${mod.name}</div></div><div class="module-meta"><span class="module-sem">${mod.sem}</span>${mod.coef>0?`<span class="module-coef">Coef. ${mod.coef}</span>`:'<span class="module-coef" style="color:var(--text-tertiary);">Non notÃ©</span>'}</div><div class="eval-weights"><div class="eval-weights-title">PondÃ©ration</div><div class="eval-weight-bar">${buildEvalWeightBar(mod.evals)}</div></div><div class="module-grades">${chips}</div><div class="module-average"><span class="avg-label">${result?.weighted?'moy.pond.':'moy.'}</span><div class="avg-bar"><div class="avg-bar-fill" style="width:${barW};background:${color};"></div></div><span class="avg-value" style="color:${color}">${avgD}</span></div></div>`;
            });
        });
        const taskList=document.getElementById('taskList');
        taskList.innerHTML=data.tasks.length===0?'<div style="padding:32px;text-align:center;color:var(--text-tertiary);">Aucune tÃ¢che</div>':data.tasks.map((t,i)=>`<div class="task-item ${t.done?'done':''}"><div class="task-check" onclick="toggleTask(${i})">${t.done?'âœ“':''}</div><div class="task-text" onclick="toggleTask(${i})">${t.text}</div><button class="btn btn-danger" onclick="deleteTask(${i})" style="min-height:36px;padding:6px 10px;">âœ•</button></div>`).join('');
        renderSchedule();renderResources();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INIT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    applyTheme();
    updateModuleSelect();
    updateResModuleSelect();
    refreshUI();
    updateICSStatus();
    </script>
</body>
</html>
